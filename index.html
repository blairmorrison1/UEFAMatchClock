<!DOCTYPE html>
<html lang="en" style="height:100%;margin:0;padding:0">
<head>
<meta charset="UTF-8">
<title>UEFA Match Clock</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
  html,body{
    margin:0;padding:0;height:100%;width:100%;
    box-sizing:border-box;
    font-family:'Roboto',Helvetica,Arial,sans-serif;
    font-variant:tabular-nums;font-feature-settings:"tnum";
    color:#fff;
    transition:background-image .6s ease-in-out;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  /* Base neutral background (used when no PNG set) */
  body{
    background-color:#0a0a0c;
    background-repeat:no-repeat;
    background-position:center;
    background-size:cover;
  }

  /* Selector panel — redesigned */
  .selectors {
    position: relative;
    margin-top: 3vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 18px 26px;
    border-radius: 18px;
    backdrop-filter: blur(12px);
    background: rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 0 25px rgba(0,0,0,0.45);
    animation: subtleGlow 3s ease-in-out infinite alternate;
    transition: opacity .5s ease, height .5s ease;
    height:auto;
    max-height: 55vh;
    overflow-y: auto;
  }

  @keyframes subtleGlow {
    from { box-shadow: 0 0 22px rgba(255,255,255,0.12); }
    to   { box-shadow: 0 0 35px rgba(255,255,255,0.25); }
  }

  /* Inputs */
  input[type="date"], select {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 10px;
    padding: 12px 16px;
    font-size: 1.1rem;
    color: #fff;
    width: 220px;
    cursor: pointer;
    transition: 0.25s ease;
    text-align: center;
  }

  input:hover, select:hover {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.35);
  }

  input:focus, select:focus {
    outline: none;
    background: rgba(255,255,255,0.20);
    border-color: #fff;
  }

  select option {
    background: #181818;
    color: #fff;
  }

  @media (max-width: 900px) {
    .selectors {
      flex-direction: column;
      gap: 12px;
    }
  }

  /* Manual Mode */
  .manual-btn {
    margin-top: 2vh;
    padding: 10px 22px;
    font-size: 1.1rem;
    cursor: pointer;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(255,255,255,0.08);
    color: #fff;
    transition: 0.2s;
  }

  .manual-btn:hover {
    background: rgba(255,255,255,0.18);
    border-color: rgba(255,255,255,0.35);
  }

  .manual-mode {
    margin-top: 2vh;
    display: none;
    flex-direction: column;
    gap: 14px;
    width: 300px;
    padding: 18px 26px;
    align-items: center;
    text-align: center;
    border-radius: 18px;
    backdrop-filter: blur(12px);
    background: rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 0 25px rgba(0,0,0,0.45);
    animation: subtleGlow 3s ease-in-out infinite alternate;
    position:relative;
    z-index:5;
  }

  .manual-input {
    width: 100%;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 10px;
    padding: 12px 15px;
    font-size: 1rem;
    color: white;
    text-align: center;
  }

  .manual-input:focus {
    background: rgba(255,255,255,0.15);
    outline: none;
  }

  /* Clock at top */
  #clocktext{
    font-size:300pt;
    font-weight:700;
    text-align:center;
    margin-top:8vh;
    margin-bottom:2vh;
    text-shadow:0 0 6px rgba(0,0,0,.25);
  }

  /* Teams below clock */
  .match-header{
    margin-top:0;
    display:none;
    flex-direction:column;
    align-items:center;
    text-align:center;
    opacity:0;
  }

  .match-header.fade-in{
    display:flex;
    animation:fadeInTeams 0.9s ease forwards;
  }

  @keyframes fadeInTeams{
    from{opacity:0;transform:translateY(20px);}
    to{opacity:1;transform:translateY(0);}
  }

  .teams-row{
    display:flex;align-items:center;justify-content:center;
    gap:70px;width:85%;max-width:1800px;
  }

  .team{display:flex;align-items:center;justify-content:center;gap:25px;}
  .team-logo{width:140px;height:140px;object-fit:contain;}
  .team-name{
    font-weight:700;
    font-size:5.2rem;
    text-transform:uppercase;
    color:#fff;
    text-align:center;
    max-width:600px;
    line-height:1;

    /* smarter wrapping */
    white-space: normal;
    word-break: keep-all;
    overflow-wrap: normal;
    hyphens: none;
  }
  .vs{font-weight:700;font-size:4.5rem;color:#fff;padding:0 25px;}

  /* Unified info at bottom */
  .info-section{
    position:absolute;
    bottom:3vh;
    display:none;
    flex-direction:column;
    align-items:center;
    text-align:center;
    gap:10px;
    opacity:0;
  }

  .info-section.fade-in{
    display:flex;
    animation:fadeInInfo 1s ease forwards;
  }

  #kickoffTime{
    font-size:2.4rem;
    font-weight:700;
    letter-spacing:0.03em;
    color:#fff;
  }

  #countdown{
    font-size:1.8rem;
    font-weight:500;
    color:#fff;
  }

  .live{ color:#00ff5e; font-weight:700;
    animation:pulse 1s ease-in-out infinite alternate;
  }

  @keyframes pulse{from{opacity:.7;}to{opacity:1;}}

  .info-panel{
    text-align:center;
    font-size:1.8rem;
    line-height:2.2rem;
    color:#fff;
  }

  .info-label{font-weight:500;color:#ffffffcc;}

  @keyframes fadeInInfo{
    from{opacity:0;transform:translateY(15px);}
    to{opacity:1;transform:translateY(0);}
  }

  /* Hide logos when empty */
  .team-logo[src=""]{
    display: none;
  }

  /* Extra timings toggle + config inside selectors */
  .extra-toggle {
    display:flex;
    align-items:center;
    gap:8px;
    font-size:0.95rem;
    color:#ffffffdd;
    cursor:pointer;
  }
  .extra-toggle input {
    width:auto;
  }

  .extra-config {
    display:none;
    flex-direction:column;
    gap:10px;
    width:100%;
    align-items:center;
  }

  /* Helper info box for extra timings */
  .extra-info {
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.20);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.85rem;
    color: #ffffffcc;
    margin-top: 4px;
    margin-bottom: 4px;
    text-align: center;
    line-height: 1.3;
    display: none; /* shown when checkbox enabled */
  }

  /* Floating extra timings display (bottom-right) */
  .extra-display{
    position:absolute;
    right:3vw;
    bottom:3vh;
    min-width:400px;   /* ~25% bigger */
    max-width:550px;
    padding:18px 22px;
    border-radius:20px;
    backdrop-filter:blur(12px);
    background:rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.20);
    box-shadow:0 0 22px rgba(0,0,0,0.6);
    font-size:1.3rem;
    display:none;
  }

  /* Floating VoIP display (bottom-left) */
  .voip-display{
    position:absolute;
    left:3vw;
    bottom:3vh;
    min-width:325px;
    max-width:425px;
    padding:18px 22px;
    border-radius:20px;
    backdrop-filter:blur(12px);
    background:rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.20);
    box-shadow:0 0 22px rgba(0,0,0,0.6);
    font-size:1.3rem;
    display:none;
  }

  .extra-title{
    font-weight:600;
    font-size:1rem;
    margin-bottom:6px;
    text-align:right;
    color:#ffffffdd;
  }
  .extra-row{
    display:flex;
    justify-content:space-between;
    gap:10px;
    margin:2px 0;
    font-variant-numeric:tabular-nums;
  }
  .extra-name{
    opacity:0.9;
  }
  .extra-time{
    font-weight:600;
  }

  .extra-upcoming   { color:#ffffff; }
  .extra-amber      { color:#ffb347; }
  .extra-red        { color:#ff4c4c; }
  .extra-ongoing    { color:#00ff8a; }
  .extra-complete   { color:#aaaaaa; }

</style>
</head>

<body>

<!-- Clock -->
<span id="clocktext">00:00:00</span>

<!-- Automatic mode selectors -->
<div class="selectors" id="selectors">
  <input type="date" id="matchDate"/>
  <select id="matchSelect"><option value="">Select a match</option></select>

  <!-- Extra timings toggle + config -->
  <label class="extra-toggle">
    <input type="checkbox" id="useExtraTimings">
    <span>Use additional timings</span>
  </label>

  <div class="extra-config" id="extraConfig">
    <div id="extraInfo" class="extra-info">
      Add all additional timings before selecting a match.<br>
      Selecting a match will hide this panel.
    </div>

    <select id="extraType" class="manual-input">
      <option value="">Choose event</option>
      <option value="Pitch Access">Pitch Access</option>
      <option value="Nudge">Nudge</option>
      <option value="End to End Test">End to End Test</option>
      <option value="Ref Test">Ref Test</option>
      <option value="CUSTOM">Custom...</option>
    </select>

    <input id="customEventName" class="manual-input" placeholder="Custom event name" style="display:none;">

    <input id="extraTime" class="manual-input" type="time">

    <button id="addExtra" type="button" class="manual-btn">Add timing</button>
  </div>

  <!-- VOIP SECTION -->
  <label class="extra-toggle">
    <input type="checkbox" id="useVoip">
    <span>Show VoIP Numbers</span>
  </label>

  <div class="extra-config" id="voipConfig">
    <select id="voipType" class="manual-input">
      <option value="">Choose VoIP Line</option>
      <option value="RRA">RRA</option>
      <option value="Emergency Comms">Emergency Comms</option>
      <option value="VTG">VTG</option>
      <option value="Nyon">Nyon</option>
      <option value="VAR">VAR</option>
    </select>

    <input id="voipNumber" class="manual-input" placeholder="Enter number">

    <button id="addVoip" type="button" class="manual-btn">Add VoIP</button>
  </div>
</div>

<!-- Manual mode toggle -->
<button id="manualModeBtn" class="manual-btn">Manual Mode</button>

<!-- Manual Mode Panel -->
<div class="manual-mode" id="manualMode">
  <input type="text" id="manualHome" class="manual-input" placeholder="Home team">
  <input type="text" id="manualAway" class="manual-input" placeholder="Away team">

  <select id="manualBackground" class="manual-input">
    <option value="NEUTRAL">Neutral Background</option>
    <option value="UCL">Champions League</option>
    <option value="UEL">Europa League</option>
    <option value="EQ">Qualifiers</option>
    <option value="UCONF">Nations League</option>
    <option value="UNL">Nations League (UNL)</option>
    <option value="USC">Super Cup</option>
    <option value="UWCL">Women&rsquo;s Champions League</option>
  </select>

  <button id="manualApply" class="manual-btn apply">Apply</button>
</div>

<!-- Teams -->
<div class="match-header" id="matchHeader">
  <div class="teams-row">
    <div class="team home">
      <img id="homeLogo" class="team-logo" src="" alt="">
      <span class="team-name" id="homeName"></span>
    </div>
    <div class="vs" id="vsText">vs</div>
    <div class="team away">
      <span class="team-name" id="awayName"></span>
      <img id="awayLogo" class="team-logo" src="" alt="">
    </div>
  </div>
</div>

<!-- Info below -->
<div class="info-section" id="infoSection">
  <div id="kickoffTime"></div>
  <div id="countdown"></div>
  <div class="info-panel" id="infoPanel">
    <div><span class="info-label">Match ID:</span> <span id="matchID">—</span></div>
    <div><span class="info-label">Stadium:</span> <span id="stadiumSponsor">—</span></div>
    <div><span class="info-label">City:</span> <span id="stadiumCity">—</span></div>
  </div>
</div>

<!-- Floating Extra Timings panel -->
<div class="extra-display" id="extraDisplay">
  <div class="extra-title">Additional Timings</div>
  <div id="extraRows"></div>
</div>

<!-- Floating VoIP panel -->
<div class="voip-display" id="voipDisplay">
  <div class="extra-title">VoIP Numbers</div>
  <div id="voipRows"></div>
</div>

<script>
const selDate      = document.getElementById('matchDate'),
      selMatch     = document.getElementById('matchSelect'),
      selectors    = document.getElementById('selectors'),
      header       = document.getElementById('matchHeader'),
      infoSection  = document.getElementById('infoSection'),
      home         = document.getElementById('homeName'),
      away         = document.getElementById('awayName'),
      hLogo        = document.getElementById('homeLogo'),
      aLogo        = document.getElementById('awayLogo'),
      mID          = document.getElementById('matchID'),
      sName        = document.getElementById('stadiumSponsor'),
      sCity        = document.getElementById('stadiumCity'),
      koElem       = document.getElementById('kickoffTime'),
      cdElem       = document.getElementById('countdown'),
      manualBtn    = document.getElementById('manualModeBtn'),
      manualPanel  = document.getElementById('manualMode'),
      manualHome   = document.getElementById('manualHome'),
      manualAway   = document.getElementById('manualAway'),
      manualBG     = document.getElementById('manualBackground'),
      manualApply  = document.getElementById('manualApply');

const useExtra       = document.getElementById('useExtraTimings');
const extraConfig    = document.getElementById('extraConfig');
const extraInfo      = document.getElementById('extraInfo');
const extraType      = document.getElementById('extraType');
const customEventName= document.getElementById('customEventName');
const extraTimeInput = document.getElementById('extraTime');
const addExtraBtn    = document.getElementById('addExtra');
const extraDisplay   = document.getElementById('extraDisplay');
const extraRows      = document.getElementById('extraRows');

const useVoip       = document.getElementById('useVoip');
const voipConfig    = document.getElementById('voipConfig');
const voipType      = document.getElementById('voipType');
const voipNumber    = document.getElementById('voipNumber');
const addVoipBtn    = document.getElementById('addVoip');
const voipDisplay   = document.getElementById('voipDisplay');
const voipRows      = document.getElementById('voipRows');

let matches = [], timer, extraTimer = null;
let extraEvents = [];
let voipEntries = [];

// ----- TEAM / BACKGROUND HELPERS -----
function teamName(t){
  return t?.translations?.displayName?.EN || t?.internationalName || t?.teamCode || 'Unknown';
}

// NEW: smarter wrapping / non-breaking logic for multi-word names
function formatTeamName(raw){
  if (!raw) return '';

  const parts = raw.trim().split(' ');

  const prefixes = ['FC', 'AC', 'SC', 'RB', 'SV', 'PSG', 'B.', 'Man'];
  const suffixes = ['UTD', 'UT', 'UNITED', 'CITY', 'SG', 'FK', 'CF', 'FC'];

  const p0 = parts[0].toUpperCase();
  const p1 = parts[1]?.toUpperCase();

  // Case 1: Known short football prefix → glue first two words
  if (parts.length > 1 && prefixes.includes(p0)) {
    parts[0] = parts[0] + '\u00A0' + parts[1];
    parts.splice(1, 1);
  }

  // Case 2: Known football suffix → glue last two words
  if (
    parts.length === 2 &&
    suffixes.includes(p1)
  ) {
    return parts[0] + '\u00A0' + parts[1];
  }

  // Case 3: Two short words like PSG SG, Man Utd
  if (
    parts.length === 2 &&
    parts[0].length <= 4 &&
    parts[1].length <= 3
  ) {
    return parts[0] + '\u00A0' + parts[1];
  }

  // Case 4: 3+ word names → glue first two to avoid 3 lines
  if (parts.length > 2) {
    parts[0] = parts[0] + '\u00A0' + parts[1];
    parts.splice(1, 1);
  }

  return parts.join(' ');
}

function bgCode(m){
  const c = m?.competition?.code;
  const id = String(m?.competition?.id); // force string
  const parentId = String(m?.competition?.parentCompetitionId);

  // Qualifiers
  if(['FWC','EQ','WC'].includes(c) || id === '17' || parentId === '17') {
    return 'EQ';
  }

  // UWNL – World Cup Women's Nations League
  if (id === '39' || parentId === '39') {
    return 'UWNL';
  }

  return c;
}

function setBG(m){
  const code  = bgCode(m);
  const known = ['EQ','UCL','UCONF','UEL','UNL','USC','UWCL','UWNL'];

  if(code && known.includes(code)){
    document.body.style.backgroundImage = `url('Background/${code}.png')`;
  } else {
    document.body.style.backgroundImage = 'none';
    document.body.style.backgroundColor = '#0a0a0c';
  }
}

// ----- LOAD MATCHES -----
async function load(){
  try{
    const r=await fetch('uefa_matches.json?_=' + Date.now());
    const d=await r.json();
    matches=Array.isArray(d)?d:(Array.isArray(d.matches)?d.matches:[d]);
    const dates=[...new Set(matches.map(m=>m.kickOffTime?.date))].sort();
    if(dates[0]){selDate.value=dates[0];fill(dates[0]);}
  }catch(e){console.error(e);}
}

function fill(date){
  selMatch.innerHTML='<option value="">Select a match</option>';
  matches.filter(m=>m.kickOffTime?.date===date).forEach(m=>{
    const o=document.createElement('option'),
          ko=m.kickOffTime?.dateTime?new Date(m.kickOffTime.dateTime):null,
          t=ko?ko.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}):'TBC';
    o.value=m.id;
    o.textContent=`${teamName(m.homeTeam)} vs ${teamName(m.awayTeam)} – ${t}`;
    selMatch.appendChild(o);
  });
}
selDate.addEventListener('change',e=>fill(e.target.value));

// ----- MAIN KICK-OFF COUNTDOWN -----
function countdown(t){
  clearInterval(timer);
  timer=setInterval(()=>{
    const now=new Date(),d=t-now;
    if(d<=0){
      cdElem.textContent='Match Live';
      cdElem.classList.add('live');
      return clearInterval(timer);
    }
    const totalSeconds=Math.floor(d/1000),
          weeks=Math.floor(totalSeconds/604800),
          days=Math.floor((totalSeconds%604800)/86400),
          hours=Math.floor((totalSeconds%86400)/3600),
          minutes=Math.floor((totalSeconds%3600)/60),
          seconds=totalSeconds%60;

    let parts=[];
    if(weeks>0)parts.push(`${weeks}w`);
    if(days>0)parts.push(`${days}d`);
    if(hours>0)parts.push(`${hours}h`);
    if(minutes>0)parts.push(`${minutes}m`);
    parts.push(`${seconds}s`);

    cdElem.textContent=`Countdown to Kick-off: ${parts.join(' ')}`;
  },1000);
}

// ----- EXTRA TIMINGS LOGIC -----
useExtra.addEventListener('change', () => {
  const enabled = useExtra.checked;
  extraConfig.style.display = enabled ? 'flex' : 'none';
  extraInfo.style.display   = enabled ? 'block' : 'none';

  if(!enabled){
    extraEvents = [];
    updateExtraDisplay();
  }
});

extraType.addEventListener('change',()=>{
  if(extraType.value === 'CUSTOM'){
    customEventName.style.display = 'block';
  }else{
    customEventName.style.display = 'none';
    customEventName.value = '';
  }
});

addExtraBtn.addEventListener('click',()=>{

  if(!useExtra.checked) return;

  let name;
  if(!extraType.value) return;

  if(extraType.value === 'CUSTOM'){
    if(!customEventName.value.trim()) return;
    name = customEventName.value.trim();
  } else {
    name = extraType.value;
  }

  if(!extraTimeInput.value) return;

  // Prevent duplicates — same event only once
  if (extraEvents.some(e => e.name === name)) {
    alert(`The event "${name}" is already added.`);
    return;
  }

  const [h,m] = extraTimeInput.value.split(':').map(Number);
  const now = new Date();
  const evtTime = new Date();
  evtTime.setHours(h, m, 0, 0);
  if(evtTime < now){
    evtTime.setDate(evtTime.getDate()+1);
  }

  const durationMinutes = (name === 'Nudge') ? 120 : 30;
  const durationMs = durationMinutes*60*1000;

  extraEvents.push({
    name,
    time: evtTime,
    durationMs
  });

  updateExtraDisplay();
  startExtraTimerLoop();
});

function startExtraTimerLoop(){
  if(extraTimer !== null) return; // already running
  extraTimer = setInterval(updateExtraDisplay, 1000);
}

function updateExtraDisplay(){
  if(!useExtra.checked || extraEvents.length === 0){
    extraDisplay.style.display = 'none';
    return;
  }

  const now = new Date();

  const stillActive = [];
  const decorated = [];

  extraEvents.forEach(evt => {
    const startDiff = evt.time - now;
    const endTime = new Date(evt.time.getTime() + evt.durationMs);
    let state, displayText, cssClass, sortBucket, sortTime;

    if(startDiff > 0){
      // Upcoming
      const totalSeconds = Math.floor(startDiff/1000);
      const minutes = Math.floor(totalSeconds/60);
      const hours = Math.floor(minutes/60);
      const remMin = minutes%60;

      if(minutes > 60){
        state = 'UPCOMING';
        cssClass = 'extra-upcoming';
        displayText = `${hours}h ${remMin}m`;
      }else if(minutes > 15){
        state = 'UPCOMING_AMBER';
        cssClass = 'extra-amber';
        displayText = `${minutes}m`;
      }else{
        state = 'UPCOMING_RED';
        cssClass = 'extra-red';
        displayText = `${minutes}m`;
      }
      sortBucket = 1;
      sortTime = evt.time.getTime();
    } else {
      // Started
      if(now <= endTime){
        state = 'ONGOING';
        cssClass = 'extra-ongoing';
        displayText = 'Ongoing';
        sortBucket = 0;
        sortTime = evt.time.getTime();
      } else {
        // Completed: drop it from the list
        return;
      }
    }

    stillActive.push(evt);
    decorated.push({evt, state, displayText, cssClass, sortBucket, sortTime});
  });

  extraEvents = stillActive;

  if(decorated.length === 0){
    extraDisplay.style.display = 'none';
    return;
  }

  decorated.sort((a,b)=>{
    if(a.sortBucket !== b.sortBucket) return a.sortBucket - b.sortBucket;
    return a.sortTime - b.sortTime;
  });

  extraRows.innerHTML = '';
  decorated.forEach(item=>{
    const row = document.createElement('div');
    row.className = `extra-row ${item.cssClass}`;

    const nameSpan = document.createElement('span');
    nameSpan.className = 'extra-name';
    nameSpan.textContent = item.evt.name;

    const timeSpan = document.createElement('span');
    timeSpan.className = 'extra-time';
    timeSpan.textContent = item.displayText;

    row.appendChild(nameSpan);
    row.appendChild(timeSpan);
    extraRows.appendChild(row);
  });

  extraDisplay.style.display = 'block';
}

// ----- VOIP LOGIC -----
useVoip.addEventListener('change', () => {
  const enabled = useVoip.checked;
  voipConfig.style.display = enabled ? 'flex' : 'none';
  if (!enabled) {
    voipEntries = [];
  }
  updateVoipDisplay();
});

addVoipBtn.addEventListener('click', () => {
  if (!useVoip.checked) return;
  if (!voipType.value) return;

  const number = voipNumber.value.trim();
  if (!number) return;

  const name = voipType.value;

  // overwrite existing entry for same name
  const existingIndex = voipEntries.findIndex(v => v.name === name);
  if (existingIndex !== -1) {
    voipEntries[existingIndex].number = number;
  } else {
    voipEntries.push({ name, number });
  }

  updateVoipDisplay();
});

function updateVoipDisplay(){
  if (!useVoip.checked || voipEntries.length === 0){
    voipDisplay.style.display = 'none';
    return;
  }

  voipRows.innerHTML = '';

  voipEntries.forEach(v => {
    const row = document.createElement('div');
    row.className = 'extra-row extra-upcoming';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'extra-name';
    nameSpan.textContent = v.name;

    const numSpan = document.createElement('span');
    numSpan.className = 'extra-time';
    numSpan.textContent = v.number;

    row.appendChild(nameSpan);
    row.appendChild(numSpan);
    voipRows.appendChild(row);
  });

  voipDisplay.style.display = 'block';
}

// ----- MATCH SELECTION -----
selMatch.addEventListener('change',()=>{
  const id=selMatch.value,m=matches.find(x=>x.id==id);if(!m)return;
  extraInfo.style.display = 'none';

  // use formatted names here
  home.textContent=formatTeamName(teamName(m.homeTeam));
  away.textContent=formatTeamName(teamName(m.awayTeam));

  hLogo.src=m.homeTeam?.mediumLogoUrl||'';
  aLogo.src=m.awayTeam?.mediumLogoUrl||'';

  mID.textContent=m.id||'—';
  sName.textContent=m.stadium?.translations?.sponsorName?.EN||
                     m.stadium?.translations?.officialName?.EN||'Unknown Stadium';
  sCity.textContent=m.stadium?.city?.translations?.name?.EN||'Unknown City';

  setBG(m);

  const ko=m.kickOffTime?.dateTime?new Date(m.kickOffTime.dateTime):null;
  if(ko&&!isNaN(ko)){
    const cetTime=ko.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',timeZone:'Europe/Paris'});
    const localTime=ko.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    const cetDate=ko.toLocaleDateString('en-GB',{timeZone:'Europe/Paris'});
    const localDate=ko.toLocaleDateString('en-GB');
    const sameTime=(cetTime===localTime)&&(cetDate===localDate);

    koElem.textContent=sameTime
      ?`Kick-off: ${cetTime} CET`
      :`Kick-off: ${cetTime} CET (${localTime} local)`;

    countdown(ko);
  }else{
    koElem.textContent='Kick-off: TBC';
    cdElem.textContent='';
  }

  // Smooth fade + collapse selectors
  selectors.style.opacity="0";
  selectors.style.height="0px";
  selectors.style.pointerEvents="none";

  manualBtn.style.display="none";

  // Animate teams + info
  header.classList.remove('fade-in');
  infoSection.classList.remove('fade-in');
  void header.offsetWidth;
  void infoSection.offsetWidth;

  header.classList.add('fade-in');
  infoSection.classList.add('fade-in');

  // Ensure extra + VoIP panels reflect current state
  updateExtraDisplay();
  updateVoipDisplay();
});

// ---------- MANUAL MODE ----------
manualBtn.addEventListener('click',(e)=>{
  e.stopPropagation();
  manualBtn.style.display='none';
  selectors.style.display='none';
  manualPanel.style.display='flex';
});

manualPanel.addEventListener('click',(e)=>e.stopPropagation());

manualApply.addEventListener('click',()=>{

  const h=manualHome.value.trim();
  const a=manualAway.value.trim();
  if(!h||!a){alert("Enter both team names");return;}

  // use same formatter for manual names
  home.textContent=formatTeamName(h);
  away.textContent=formatTeamName(a);
  hLogo.src="";
  aLogo.src="";

  const bg=manualBG.value;
  if(bg === 'NEUTRAL'){
    document.body.style.backgroundImage = 'none';
    document.body.style.backgroundColor = '#0a0a0c';
  }else{
    document.body.style.backgroundImage = `url('Background/${bg}.png')`;
  }

  // Hide bottom info for manual mode (no KO, match ID, etc.)
  infoSection.style.display='none';

  manualPanel.style.display='none';

  header.classList.remove('fade-in');
  void header.offsetWidth;
  header.classList.add('fade-in');

  // Extra timings + VoIP still valid in manual mode if configured
  updateExtraDisplay();
  updateVoipDisplay();
});

// ---------- LIVE CLOCK ----------
const txt=document.getElementById('clocktext');
(function tick(){
  const d=new Date(),h=d.getHours().toString().padStart(2,'0'),
        m=d.getMinutes().toString().padStart(2,'0'),
        s=d.getSeconds().toString().padStart(2,'0');
  txt.textContent=`${h}:${m}:${s}`;
  setTimeout(tick,1020-d.getMilliseconds());
})();
load();
</script>
</body>
</html>
